# Generating the Azure-PlantUML distro

If you want to have customized builds and/or experiment with Azure-PlantUML, you can generate the Azure-PlantUML distro yourself.

## Prerequisites

The following software must be installed in your environment:

* [dotnet script](https://github.com/filipw/dotnet-script) for executing the scripts
* [PlantUML](https://chocolatey.org/packages/plantuml)
* [Inkscape](https://inkscape.org/)
* [rsvg-convert](https://chocolatey.org/packages/rsvg-convert#individual)

## Configure

Download the [Azure Architecture Icons](https://docs.microsoft.com/en-us/azure/architecture/icons) and copy all folders from `Azure_Public_Service_Icons` to the [source/official](../source/official) directory.

Place any .svg files that are not included in the Architecture Center icon distribution into the [source/manual](../source/manual) directory. Be sure to group these files into folders that match the structure of the `official` directory.

Ensure the following variables at the beginning of `main.csx` are correct configured for your system:

```csharp
var plantUmlPath = @"C:\ProgramData\chocolatey\lib\plantuml\tools\plantuml.jar";
var inkScapePath = @"C:\Program Files\Inkscape\inkscape.exe";
static string rsvgConvertPath = @"C:\ProgramData\chocolatey\bin\rsvg-convert.exe";
```

### Configuration File: Config.yaml

This configuration file is used to map specific SVG file names to Azure services. Services are then grouped into categories. This file is currently auto-generated by the `main.csv` file.

## Run

From the `scripts` folder, execute:

```powershell
dotnet script main.csx
```

### What happens

From a logical point of view, the following happens:

1. The directory structure of `/source` is enumerated and the `Config.yaml` file is created
2. Cleanup: all files and directories from `dist` folder are deleted
3. AzureCommon.puml is copied to `dist`
4. For all configured services in `Config.yaml` the SVG is loaded
    * The `source/manual` folder is used to supplement the original SVGs from Microsoft
    * A monochrome SVG is generated (necessary for PlantUML support)
5. From colored SVG a PNG is generated
6. From the monochrome SVG a PNG with white background is generated. This is needed for PlantUML sprite generation
7. A PlantUML sprite is generated
8. In a second round a PNG without background is generated from the monochrome SVG

    > During this process, it is ensured that the max size of length and width do not exeed `targetMaxSize`.

9. In addition to single Azure services PUML files, also a combined PUML file per category is generated
10. A markdown table with all Azure services, their colored and monochrom symbols and the PUML files is generated
11. VSCode snippets for all Azure services for their PlantUML usage are generated
